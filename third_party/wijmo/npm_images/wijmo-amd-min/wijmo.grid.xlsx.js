/*
    *
    * Wijmo Library 5.20171.282
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the Wijmo Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */
define(["require","exports",'wijmo/wijmo.grid','wijmo/wijmo.xlsx','wijmo/wijmo','wijmo/wijmo.grid.xlsx'],function(n,t,i,r,u,f){"use strict";function e(){var n,t;return(n=window.wijmo)&&(t=n.grid)&&t.detail}function o(){var n,t;return(n=window.wijmo)&&(t=n.grid)&&t.multirow}window.wijmo=window.wijmo||{};window.wijmo.grid=window.wijmo.grid||{};window.wijmo.grid.xlsx=f;'use strict';var s=function(){function n(){}return n.save=function(n,t,i){var r=this._saveFlexGridToWorkbook(n,t);return i&&r.save(i),r},n.saveAsync=function(n,t,i,r,u){var f=this._saveFlexGridToWorkbook(n,t);return f.saveAsync(i,r,u),f},n.load=function(n,t,i){var o=this,f,e;if(t instanceof Blob)f=new FileReader,f.onload=function(){var u=r.Workbook._base64EncArr(new Uint8Array(f.result)),t=new r.Workbook;t.load(u);o._loadToFlexGrid(n,t,i)},f.readAsArrayBuffer(t);else if(t instanceof r.Workbook)this._loadToFlexGrid(n,t,i);else{if(t instanceof ArrayBuffer)t=r.Workbook._base64EncArr(new Uint8Array(t));else if(!u.isString(t))throw'Invalid workbook.';e=new r.Workbook;e.load(t);this._loadToFlexGrid(n,e,i)}},n.loadAsync=function(n,t,i,f,e){var s=this,o,h;if(t instanceof Blob)o=new FileReader,o.onload=function(){var t=r.Workbook._base64EncArr(new Uint8Array(o.result)),u=new r.Workbook;u.loadAsync(t,function(t){s._loadToFlexGrid(n,t,i);f&&f(t)},e)},o.readAsArrayBuffer(t);else if(t instanceof r.Workbook)this._loadToFlexGrid(n,t,i),f&&f(t);else{if(t instanceof ArrayBuffer)t=r.Workbook._base64EncArr(new Uint8Array(t));else if(!u.isString(t))throw'Invalid workbook.';h=new r.Workbook;h.loadAsync(t,function(t){s._loadToFlexGrid(n,t,i);f&&f(t)},e)}},n._saveFlexGridToWorkbook=function(n,t){var nt=new r.Workbook,c=new r.WorkSheet,tt=new r.WorkbookFrozenPane,ft=t&&t.includeColumnHeaders!=null?t.includeColumnHeaders:!0,g=t&&t.includeRowHeaders!=null?t.includeRowHeaders:!1,w=t&&t.includeCellStyles!=null?t.includeCellStyles:!0,st=t?t.activeWorksheet:null,l=t?t.includeColumns:null,o,v,b,y,p,s,f,e,it,a,d,et,k,rt=0,ut=0,ot=0,h=0;if(it=n.wj_sheetInfo,c.name=t?t.sheetName:'',c.visible=t?t.sheetVisible!==!1:!0,s=[],!it&&w&&(a=document.createElement('div'),a.style.visibility='hidden',n.hostElement.appendChild(a)),g){for(f=0;f<n.rowHeaders.rows.length;f++)for(s[f]=[],e=0;e<n.rowHeaders.columns.length;e++)b=n._getBindingColumn(n.rowHeaders,f,n.rowHeaders.columns[e]),y=this._getColumnSetting(b,n.columnHeaders.columns.defaultSize),s[f][e]=y,f===0&&(p=new r.WorkbookColumn,p._deserialize(y),c._addWorkbookColumn(p,e));h=e}if(ft&&n.columnHeaders.rows.length>0){for(f=0;f<n.columnHeaders.rows.length;f++){for(s[f]||(s[f]=[]),e=0;e<n.columnHeaders.columns.length;e++)b=n._getBindingColumn(n.columnHeaders,f,n.columnHeaders.columns[e]),y=this._getColumnSetting(b,n.columnHeaders.columns.defaultSize),s[f][h+e]=y,f===0&&(!l||l(b))&&(p=new r.WorkbookColumn,p._deserialize(y),c._addWorkbookColumn(p));h=0;o={};v=new r.WorkbookRow;g&&(h=this._parseFlexGridRowToSheetRow(n.topLeftCells,o,f,0,s,w,a,!1,0,l));this._parseFlexGridRowToSheetRow(n.columnHeaders,o,f,h,s,w,a,!1,0,l);o.cells.length>0&&(v._deserialize(o),c._addWorkbookRow(v,f))}ut=f}else for(s[0]||(s[0]=[]),e=0;e<n.columnHeaders.columns.length;e++)b=n._getBindingColumn(n.columnHeaders,0,n.columnHeaders.columns[e]),y=this._getColumnSetting(b,n.columnHeaders.columns.defaultSize),s[0][h+e]=y,(!l||l(b))&&(p=new r.WorkbookColumn,p._deserialize(y),c._addWorkbookColumn(p));for(f=0;f<n.cells.rows.length;f++)(h=0,o={},v=new r.WorkbookRow,d=n.rows[f],d instanceof i._NewRowTemplate)||(k=d instanceof i.GroupRow,k&&(et=u.tryCast(d,i.GroupRow),rt=et.level+1),g&&(h=this._parseFlexGridRowToSheetRow(n.rowHeaders,o,f,0,s,w,a,k,rt,l)),this._parseFlexGridRowToSheetRow(n.cells,o,f,h,s,w,a,k,rt,l),o.cells.length>0&&(v._deserialize(o),c._addWorkbookRow(v,ut+f)));for(ot=n.cells.rows.length,f=0;f<n.columnFooters.rows.length;f++)h=0,o={},v=new r.WorkbookRow,d=n.columnFooters.rows[f],k=d instanceof i.GroupRow,g&&(h=this._parseFlexGridRowToSheetRow(n.rowHeaders,o,f,0,s,w,a,k,0,l)),this._parseFlexGridRowToSheetRow(n.columnFooters,o,f,h,s,w,a,k,0,l),o.cells.length>0&&(v._deserialize(o),c._addWorkbookRow(v,ut+ot+f));return tt.rows=ft?n.frozenRows+n.columnHeaders.rows.length:n.frozenRows,tt.columns=g?n.frozenColumns+n.rowHeaders.columns.length:n.frozenColumns,c.frozenPane=tt,nt._addWorkSheet(c),!it&&w&&n.hostElement.removeChild(a),nt.activeWorksheet=st,nt},n._loadToFlexGrid=function(n,t,f){var ri=f&&f.includeColumnHeaders!=null?f.includeColumnHeaders:!0,p=f&&f.includeColumnHeaders!=null?f.includeColumnHeaders:!0,pt=f&&f.sheetIndex!=null&&!isNaN(f.sheetIndex)?f.sheetIndex:0,ui=f?f.sheetName:null,fi=f?f.sheetVisible:!0,ei=f&&(f.sheetIndex!=null&&!isNaN(f.sheetIndex)||f.sheetName!=null||f.sheetVisible!=null),e=0,h=0,tt,it,v,rt,b,w,ut,wt,g,gt,s,l,ni,k,ft,c,et,ot,ti,bt,a,st,d,y,ht,o,kt,dt,ct,lt,ii,nt,at=!1,vt={},yt;if(n.itemsSource=null,n.columns.clear(),n.rows.clear(),n.frozenColumns=0,n.frozenRows=0,kt={},dt={},h=0,rt=[],ct=[],pt<0||pt>=t.sheets.length)throw'The sheet index option is out of the sheet range of current workbook.';if(l=t.sheets[pt],l.rows!=null){for(ri&&(h=1,l.rows.length<=1&&(p=!1,h=0),wt=l.rows[0]),k=this._getColumnCount(l.rows),ni=this._getRowCount(l.rows,k),ti=l.summaryBelow,v=l.columns,e=0;e<k;e++)n.columns.push(new i.Column),!v[e]||(isNaN(+v[e].width)||(n.columns[e].width=+v[e].width),v[e].visible||v[e].visible==undefined||(n.columns[e].visible=!!v[e].visible),v[e].style&&!!v[e].style.wordWrap&&(n.columns[e].wordWrap=v[e].style.wordWrap));for(;h<ni;h++){if(ft=!1,yt=!0,s=l.rows[h],s)for(et=h+1;et<l.rows.length;)if(ot=l.rows[et],ot){(isNaN(s.groupLevel)&&!isNaN(ot.groupLevel)||!isNaN(s.groupLevel)&&s.groupLevel<ot.groupLevel)&&(ft=!0);break}else et++;for(ft&&!ti?(a&&(a.isCollapsed=at),a=new i.GroupRow,a.isReadOnly=!1,at=s.collapsed==null?!1:s.collapsed,a.level=isNaN(s.groupLevel)?0:s.groupLevel,vt[a.level]=at,this._checkParentCollapsed(vt,a.level)&&a._setFlag(i.RowColFlags.ParentCollapsed,!0),n.rows.push(a)):(bt=new i.Row,s&&this._checkParentCollapsed(vt,s.groupLevel)&&bt._setFlag(i.RowColFlags.ParentCollapsed,!0),n.rows.push(bt)),!s||!s.height||isNaN(s.height)||(n.rows[p?h-1:h].height=s.height),e=0;e<k;e++)if(s){if(c=s.cells[e],y=c?c.formula:undefined,y&&y[0]!=='='&&(y='='+y),y=y?this._parseToFlexSheetFormula(y):undefined,n.setCellData(p?h-1:h,e,y&&ei?y:this._getItemValue(c)),ft||this._setColumn(rt,e,c),ht=h*k+e,o=c?c.style:undefined,lt=r.Workbook._parseExcelFormat(c),o){if(yt=yt&&!!o.wordWrap,ii=this._getItemType(c),o.hAlign)nt=r.Workbook._parseHAlignToString(u.asEnum(o.hAlign,r.HAlign));else switch(ii){case u.DataType.Number:nt='right';break;case u.DataType.Boolean:nt='center';break;default:nt=lt&&lt.search(/[n,c,p]/i)===0?'right':'left'}kt[ht]={fontWeight:o.font&&o.font.bold?'bold':'none',fontStyle:o.font&&o.font.italic?'italic':'none',textDecoration:o.font&&o.font.underline?'underline':'none',textAlign:nt,fontFamily:o.font&&o.font.family?o.font.family:'',fontSize:o.font&&o.font.size?o.font.size+'px':'',color:o.font&&o.font.color?o.font.color:'',backgroundColor:o.fill&&o.fill.color?o.fill.color:'',whiteSpace:o.wordWrap?'pre-wrap':'normal',format:lt};o.font&&ct.indexOf(o.font.family)===-1&&ct.push(o.font.family)}if(c&&u.isNumber(c.rowSpan)&&c.rowSpan>0&&u.isNumber(c.colSpan)&&c.colSpan>0&&(c.rowSpan>1||c.colSpan>1))for(tt=h;tt<h+c.rowSpan;tt++)for(it=e;it<e+c.colSpan;it++)ht=tt*k+it,dt[ht]=new i.CellRange(h,e,h+c.rowSpan-1,e+c.colSpan-1)}else n.setCellData(p?h-1:h,e,''),this._setColumn(rt,e,undefined);s&&(this._checkParentCollapsed(vt,s.groupLevel)||s.visible||s.visible==undefined||(n.rows[p?h-1:h].visible=s.visible),n.rows[p?h-1:h].wordWrap=!!s.style&&!!s.style.wordWrap||yt)}for(a&&(a.isCollapsed=at),l.frozenPane&&(st=l.frozenPane.columns,u.isNumber(st)&&!isNaN(st)&&(n.frozenColumns=st),d=l.frozenPane.rows,u.isNumber(d)&&!isNaN(d)&&(n.frozenRows=p&&d>0?d-1:d)),e=0;e<n.columnHeaders.columns.length;e++)b=rt[e],w=n.columns[e],w.isRequired=!1,p?(g=wt?wt.cells[e]:undefined,g&&g.value?(gt=r.Workbook._parseExcelFormat(g),ut=u.Globalize.format(g.value,gt)):ut=this._numAlpha(e)):ut=this._numAlpha(e),w.header=ut,b&&(b.dataType===u.DataType.Boolean&&(w.dataType=b.dataType),w.format=b.format,w.align=b.hAlign,w.wordWrap=w.wordWrap||b.wordWrap);n.wj_sheetInfo={name:ui||l.name,visible:fi===!0?!0:l.visible!==!1,styledCells:kt,mergedRanges:dt,fonts:ct}}},n._parseFlexGridRowToSheetRow=function(n,t,f,s,h,c,l,a,v,y){var nt,b,ut,w,k,p,tt,rt,ot,ft,lt,g,it,ht,ct,st,d,vt=!1,at,et,yt;for(nt=n.grid,st=nt.wj_sheetInfo,b=n.rows[f],yt=b.recordIndex!=null?b.recordIndex:0,t.cells||(t.cells=[]),t.visible=b.isVisible,t.height=b.renderHeight||n.rows.defaultSize,t.groupLevel=a?v-1:v,a&&(t.collapsed=b.isCollapsed),b.wordWrap&&(t.style={wordWrap:b.wordWrap}),(b.constructor===i.Row||b.constructor===i._NewRowTemplate||e()&&b.constructor===e().DetailRow||o()&&b.constructor===o()._MultiRow)&&(vt=!0),w=0;w<n.columns.length;w++)if(ct=1,ht=1,et=!1,at=nt._getBindingColumn(n,f,n.columns[w]),it=null,st&&n===nt.cells?(lt=f*n.columns.length+w,st.mergedRanges&&(it=st.mergedRanges[lt]),st.styledCells&&(g=st.styledCells[lt])):c&&(g=this._getCellStyle(n,l,f,w)||{}),it||(it=nt.getMergedRange(n,f,w,!1)),it?f===it.topRow&&w===it.leftCol&&(ht=it.bottomRow-it.topRow+1,ct=this._getColSpan(n,it,y),et=!0):et=!0,!y||y(at))if(ut=h[yt][w+s],vt||a?(p=et?n.getCellData(f,w,!0):null,tt=et?n.getCellData(f,w,!1):null,ot=!1,p&&u.isString(p)&&p.length>1&&p[0]==='='&&(ot=!0),d=u.isDate(tt),k=g&&g.format?r.Workbook._parseCellFormat(g.format,d):ut&&ut.style&&ut.style.format?r.Workbook._parseCellFormat(ut.style.format,d):null,k||(d?k='m/d/yyyy':u.isNumber(tt)&&!at.dataMap?k=u.isInt(tt)?'#,##0':'#,##0.00':ot?(ft=p.toLowerCase(),ft==='=now()'?(k='m/d/yyyy h:mm',d=!0):ft==='=today()'||ft.substring(0,ft.indexOf('('))==='=date'?(k='m/d/yyyy',d=!0):ft.substring(0,ft.indexOf('('))==='=time'&&(k='h:mm AM/PM',d=!0)):k='General')):(p=et?nt.columnHeaders.getCellData(0,w,!0):null,k='General'),n===nt.cells&&a&&b.hasChildren&&w===nt.columns.firstVisibleIndex){if(p?rt=p:et&&(rt=b.getGroupHeader().replace(/<\/?\w+>/g,'')),rt==null&&!g)continue;d=u.isDate(rt);rt=typeof rt=='string'?r.Workbook._unescapeXML(rt):rt;t.cells.push({value:rt,isDate:d,formula:ot?this._parseToExcelFormula(p,d):null,colSpan:ct,rowSpan:ht,style:this._extend(this._parseCellStyle(g),{format:k,font:{bold:!0},hAlign:r.HAlign.Left,indent:v-1})})}else p=typeof p=='string'?r.Workbook._unescapeXML(p):p,tt=typeof tt=='string'?r.Workbook._unescapeXML(tt):tt,t.cells.push({value:ot?undefined:k==='General'?p:tt,isDate:d,formula:ot?this._parseToExcelFormula(p,d):null,colSpan:w<nt.columns.firstVisibleIndex?1:ct,rowSpan:ht,style:this._extend(this._parseCellStyle(g),{format:k,hAlign:g&&g.textAlign?r.Workbook._parseStringToHAlign(g.textAlign):u.isDate(tt)&&ut.style.hAlign==null?r.HAlign.Left:u.asEnum(ut.style.hAlign,r.HAlign,!0),vAlign:ht>1?n===nt.cells?r.VAlign.Top:r.VAlign.Center:null})});return s+w},n._parseCellStyle=function(n){var t=n&&n.fontSize?+n.fontSize.substring(0,n.fontSize.indexOf('px')):null;return isNaN(t)&&(t=null),{font:{bold:n&&n.fontWeight&&(n.fontWeight==='bold'||!isNaN(+n.fontWeight)&&+n.fontWeight>=700),italic:n&&n.fontStyle&&n.fontStyle==='italic',underline:n&&n.textDecoration&&n.textDecoration==='underline',family:n?this._parseToExcelFontFamily(n.fontFamily):null,size:t,color:n&&n.color?n.color:null},fill:{color:n&&n.backgroundColor?n.backgroundColor:null},borders:n?this._parseBorder(n):null,hAlign:n&&n.textAlign?r.Workbook._parseStringToHAlign(n.textAlign):null,wordWrap:n&&n.whiteSpace?n.whiteSpace.indexOf('pre')>-1?!0:!1:!1}},n._parseBorder=function(n){var t,i;for(var r in{Left:0,Right:0,Top:0,Bottom:0})i=this._parseEgdeBorder(n,r),i&&(t||(t={}),t[r.toLowerCase()]=i);return t},n._parseEgdeBorder=function(n,t){var i,e='border'+t+'Color',f=n['border'+t+'Style'],o;if(f&&f!=='none'&&f!=='hidden'){i={};f=f.toLowerCase();switch(f){case'dotted':i.style=r.BorderStyle.Dotted;break;case'dashed':i.style=r.BorderStyle.Dashed;break;case'double':i.style=r.BorderStyle.Double;break;default:i.style=r.BorderStyle.Thin}n[e]&&(o=new u.Color(n[e]),i.color=o.toString())}return i},n._parseToExcelFontFamily=function(n){var t;return n&&(t=n.split(','),t&&t.length>0&&(n=t[0].replace(/\"|\'/g,''))),n},n._parseToExcelFormula=function(n,t){var f=n.substring(1,n.indexOf('(')).toLowerCase(),i,u;switch(f){case'ceiling':case'floor':n=n.substring(0,n.lastIndexOf(')'))+', 1)';break;case'text':u=n.search(/\,\s*\"/);i=n.substring(u,n.lastIndexOf('\"'));i=r.Workbook._parseCellFormat(i.substring(i.lastIndexOf('\"')+1),t);n=n.substring(0,u)+', \"'+i+'\")'}return n},n._parseToFlexSheetFormula=function(n){var f=n.substring(1).match(/\W+(\w+)\(/),i,e,o,s,t,u;e=f&&f.length===2?f[1]:n.substring(1,n.indexOf('('));o=n.indexOf(e);switch(e.toLowerCase()){case'ceiling':case'floor':n=n.substring(0,n.lastIndexOf(','))+')';break;case'text':i=n.substring(o);t=i.substring(i.indexOf('\"'),i.lastIndexOf('\"'));t=t.substring(t.lastIndexOf('\"')+1);s=t.indexOf('0')>-1?0:'';u=r.Workbook._parseExcelFormat({value:s,style:{format:t}});u=u.replace(/m+/g,function(n){return n.toUpperCase()}).replace(/Y+/g,function(n){return n.toLowerCase()}).replace(/M+:?|:?M+/gi,function(n){return n.indexOf(':')>-1?n.toLowerCase():n});n=n.substring(0,o)+i.substring(0,i.indexOf('\"')+1)+u+n.substring(n.indexOf(t)+t.length)}return n},n._getColumnSetting=function(n,t){var i=n.renderWidth;return i=i||t,{autoWidth:!0,width:i,visible:n.visible,style:{format:n.format?r.Workbook._parseCellFormat(n.format,n.dataType===u.DataType.Date):'',hAlign:r.Workbook._parseStringToHAlign(this._toExcelHAlign(n.getAlignment())),wordWrap:n.wordWrap}}},n._toExcelHAlign=function(n){return(n=n?n.trim().toLowerCase():n,!n)?n:n.indexOf('center')>-1?'center':n.indexOf('right')>-1||n.indexOf('end')>-1?'right':n.indexOf('justify')>-1?'justify':'left'},n._getColumnCount=function(n){for(var f=0,t=0,i,r=0;r<n.length;r++)i=n[r]&&n[r].cells?n[r].cells:[],i&&i.length>0&&(t=i.length,u.isInt(i[t-1].colSpan)&&i[t-1].colSpan>1&&(t=t+i[t-1].colSpan-1),t>f&&(f=t));return f},n._getRowCount=function(n,t){for(var f=n.length,r=f-1,o=0,e,s,i;o<t;o++)n:for(;r>=0;r--)if(e=n[r],s=e&&e.cells?e.cells:[],i=s[o],i&&(i.value!=null&&i.value!==''||u.isInt(i.rowSpan)&&i.rowSpan>1)){u.isInt(i.rowSpan)&&i.rowSpan>1&&r+i.rowSpan>f&&(f=r+i.rowSpan);break n}return f},n._numAlpha=function(n){var t=Math.floor(n/26)-1;return(t>-1?this._numAlpha(t):'')+String.fromCharCode(65+n%26)},n._getItemType=function(n){return n===undefined||n===null||n.value===undefined||n.value===null||isNaN(n.value)?undefined:u.getType(n.value)},n._setColumn=function(n,t,i){var e,o,s,f=n[t];f?(e=this._getItemType(i),f.dataType!==e&&f.dataType===u.DataType.Boolean&&e!==u.DataType.Boolean&&(f.dataType=e),i&&i.value!=null&&i.value!==''&&(o=r.Workbook._parseExcelFormat(i),o&&f.format!==o&&o!=='General'&&(f.format=o)),i&&i.style&&(i.style.hAlign&&(s=r.Workbook._parseHAlignToString(u.asEnum(i.style.hAlign,r.HAlign))),f.wordWrap=f.wordWrap&&!!i.style.wordWrap),s||e!==u.DataType.Number||(s='right'),f.hAlign=s):n[t]={dataType:this._getItemType(i),format:r.Workbook._parseExcelFormat(i),hAlign:'',wordWrap:!0}},n._getItemValue=function(n){if(n===undefined||n===null||n.value===undefined||n.value===null)return undefined;var t=n.value;return u.isNumber(t)&&isNaN(t)?'':t instanceof Date&&isNaN(t.getTime())?'':t},n._getCellStyle=function(n,t,i,r){try{this._resetCellStyle(t);n.grid.cellFactory.updateCell(n,i,r,t)}catch(u){return undefined}return window.getComputedStyle(t)},n._resetCellStyle=function(n){for(var t in n.style)typeof n.style[t]=='string'&&isNaN(+t)&&(n.style[t]='')},n._extend=function(n,t){var i,r;for(i in t)r=t[i],u.isObject(r)&&n[i]?u.copy(n[i],r):n[i]=r;return n},n._checkParentCollapsed=function(n,t){var i=!1;return Object.keys(n).forEach(function(r){n[r]===!0&&i===!1&&!isNaN(t)&&+r<t&&(i=!0)}),i},n._getColSpan=function(n,t,i){for(var u=0,r=t.leftCol;r<=t.rightCol;r++)(!i||i(n.columns[r]))&&u++;return u},n}();t.FlexGridXlsxConverter=s})